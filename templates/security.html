{% extends "base.html" %}

{% block title %}Security Management - IoT Home Security{% endblock %}

{% block content %}
<div class="security-container">
    <div class="page-header">
        <h1>üîí Security Management</h1>
        <p>Manage security settings and view intrusion history</p>
    </div>

    <!-- Security Status Banner -->
    <div class="security-status-banner" id="securityBanner">
        <div class="banner-content">
            <span class="banner-icon">üõ°Ô∏è</span>
            <div class="banner-text">
                <h3>System Mode: <span id="currentMode">Loading...</span></h3>
                <p id="modeDescription">Loading system status...</p>
            </div>
        </div>
    </div>

    <!-- Mode Control Section -->
    <div class="mode-control-section">
        <h2>System Mode Control</h2>
        <div class="mode-buttons">
            <button class="mode-btn mode-home" onclick="setSystemMode('Home')">
                <span class="mode-icon">üè†</span>
                <span class="mode-name">Home</span>
                <span class="mode-desc">Normal monitoring</span>
            </button>
            <button class="mode-btn mode-away" onclick="setSystemMode('Away')">
                <span class="mode-icon">üö®</span>
                <span class="mode-name">Away</span>
                <span class="mode-desc">Full security active</span>
            </button>
            <button class="mode-btn mode-night" onclick="setSystemMode('Night')">
                <span class="mode-icon">üåô</span>
                <span class="mode-name">Night</span>
                <span class="mode-desc">Reduced sensitivity</span>
            </button>
        </div>
    </div>

    <!-- Intrusion History Section -->
    <div class="intrusion-section">
        <h2>üìã Intrusion History</h2>

        <div class="history-controls">
            <div class="control-group">
                <label for="intrusionDate">Select Date:</label>
                <input type="date" id="intrusionDate" class="form-input" max="">
            </div>
            <button onclick="loadIntrusions()" class="btn btn-primary">
                <span>üîç</span> Search
            </button>
        </div>

        <div class="intrusion-results">
            <div id="intrusionCount" class="intrusion-count">
                <span class="count-number">0</span>
                <span class="count-label">intrusions found</span>
            </div>

            <div id="intrusionList" class="intrusion-list">
                <div class="no-data">Select a date to view intrusion history</div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="recent-activity">
        <h2>‚ö° Recent Activity</h2>
        <div id="activityLog" class="activity-log">
            <div class="activity-item">
                <span class="activity-time">Loading...</span>
                <span class="activity-text">Fetching recent activity...</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Set max date to today
    document.getElementById('intrusionDate').max = new Date().toISOString().split('T')[0];
    document.getElementById('intrusionDate').value = new Date().toISOString().split('T')[0];

    const modeDescriptions = {
        'Home': 'Environmental monitoring active. Motion detection disabled.',
        'Away': 'Full security mode active. Motion detection enabled with alerts.',
        'Night': 'Reduced sensitivity mode. Suitable for nighttime monitoring.'
    };

    function updateSecurityStatus() {
        fetch('/api/system-status')
            .then(response => response.json())
            .then(data => {
                const mode = data.mode || 'Home';
                document.getElementById('currentMode').textContent = mode;
                document.getElementById('modeDescription').textContent = modeDescriptions[mode];

                const banner = document.getElementById('securityBanner');
                banner.className = 'security-status-banner';
                banner.classList.add(`banner-${mode.toLowerCase()}`);

                // Highlight active mode button
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const activeBtn = document.querySelector(`.mode-${mode.toLowerCase()}`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
            })
            .catch(error => {
                console.error('Error fetching security status:', error);
            });
    }

    function setSystemMode(mode) {
        if (!confirm(`Switch to ${mode} mode?`)) {
            return;
        }

        fetch('/api/control/mode', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ value: mode })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`System mode changed to ${mode}`);
                updateSecurityStatus();
            } else {
                alert('Failed to change mode. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error setting mode:', error);
            alert('Error changing mode. Please check your connection.');
        });
    }

    function loadIntrusions() {
        const date = document.getElementById('intrusionDate').value;

        if (!date) {
            alert('Please select a date');
            return;
        }

        fetch(`/api/intrusions?date=${date}`)
            .then(response => response.json())
            .then(data => {
                const intrusions = data.intrusions || [];
                const countEl = document.querySelector('.count-number');
                const listEl = document.getElementById('intrusionList');

                countEl.textContent = intrusions.length;

                if (intrusions.length === 0) {
                    listEl.innerHTML = '<div class="no-data">No intrusions detected on this date</div>';
                } else {
                    let html = '';
                    intrusions.forEach(intrusion => {
                        const time = new Date(intrusion.timestamp).toLocaleTimeString();
                        html += `
                            <div class="intrusion-item">
                                <div class="intrusion-icon">üö®</div>
                                <div class="intrusion-content">
                                    <div class="intrusion-time">${time}</div>
                                    <div class="intrusion-details">${intrusion.details}</div>
                                </div>
                            </div>
                        `;
                    });
                    listEl.innerHTML = html;
                }
            })
            .catch(error => {
                console.error('Error loading intrusions:', error);
                alert('Error loading intrusion data. Please try again.');
            });
    }

    function updateActivityLog() {
        // This would fetch recent system events
        // For now, showing current status
        fetch('/api/system-status')
            .then(response => response.json())
            .then(data => {
                const now = new Date();
                const activityLog = document.getElementById('activityLog');

                let html = `
                    <div class="activity-item">
                        <span class="activity-time">${now.toLocaleTimeString()}</span>
                        <span class="activity-text">System mode: ${data.mode}</span>
                    </div>
                `;

                if (data.motion_detected) {
                    html += `
                        <div class="activity-item alert">
                            <span class="activity-time">${now.toLocaleTimeString()}</span>
                            <span class="activity-text">‚ö†Ô∏è Motion detected!</span>
                        </div>
                    `;
                }

                activityLog.innerHTML = html;
            })
            .catch(error => {
                console.error('Error updating activity log:', error);
            });
    }

    // Initial load
    updateSecurityStatus();
    updateActivityLog();

    // Update status every 5 seconds
    setInterval(updateSecurityStatus, 5000);
    setInterval(updateActivityLog, 5000);

    // Auto-load today's intrusions
    window.addEventListener('load', () => {
        setTimeout(loadIntrusions, 500);
    });
</script>
{% endblock %}